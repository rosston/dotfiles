#!/bin/sh

set -e

usage () {
  echo "Usage: codspace [-u|<repo_name>]"
  echo ""
  echo "To mount and start everything up:"
  echo "    codspace <repo_name>"
  echo ""
  echo "To unmount (from within the sshfs mounted directory):"
  echo "    codspace -u"
}

main () {
  local mount_base="${HOME}/codspace"
  local repo_name="$1"

  if [ $# -eq 0 ]; then
    usage
    return 1
  elif [ "$1" = "-u" ]; then
    local current_mount=$PWD

    tmux send-keys -t :.0 "cd .. && fusermount3 -u '$current_mount' && rm -r '$current_mount'" Enter
    return 0
  fi

  echo "Updating Codespaces SSH config"
  gh codespace ssh --config > ~/.ssh/codespaces

  selected_codespace=$(cat ~/.ssh/codespaces | grep '^Host' | grep "$repo_name" | sed -e 's/Host //' | fzf)
  mount_point="${mount_base}/${selected_codespace}"

  echo "Mounting Codespace with sshfs"
  mkdir -p "$mount_point"
  sshfs "${selected_codespace}:/workspaces/${repo_name}" "$mount_point"

  local num_panes="3"

  times=`expr "$num_panes" - 1`

  tmux rename-window "$selected_codespace"

  # Create other panes
  for i in `seq 1 "$times"`; do
    dwm.tmux newpanecurdir
  done

  # Rotate back to the original pane
  dwm.tmux rotatecw

  sleep 0.5
  tmux send-keys -t :.0 "cd '$mount_point' && SSH_REMOTE='$selected_codespace' REPO_NAME='$repo_name' nvim" Enter

  dwm.tmux rotateccw
  sleep 0.5
  tmux send-keys -t :.0 "cd '$mount_point' && ssh '${selected_codespace}'" Enter
  tmux send-keys -t :.0 "git fetch -p && git status" Enter

  dwm.tmux rotateccw
  sleep 0.5
  tmux send-keys -t :.0 "cd '$mount_point' && ssh '${selected_codespace}'" Enter

  dwm.tmux rotateccw
}

main $@
